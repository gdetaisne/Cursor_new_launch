# Commits pour P0-t005

## [423873d] P0-t005: Complete Prisma schema specification
**Date** : 2025-11-10

**Fichiers** :
- .cursor/tasks/P0-t005-schema-core-back-office.md

**Changements** :
Création complète du schéma Prisma avec 11 tables et 8 enums :

**Tables** :
- Lead : prospects des 11 sites locaux
- Client : données clients
- Folder : dossiers déménagement complets (adresses, volume, options)
- Mover : déménageurs (Google Places, scoring financier manuel)
- PricingGrid : grilles tarifaires (m³ × km, paliers)
- Quote : devis (AUTO_GENERATED/EMAIL_PARSED/MANUAL)
- Booking : réservations confirmées
- Payment : paiements + reversements (commission 5-15%)
- User : comptes admin/operator/partner
- EmailLog : tracking emails (statuts, tracking ouvertures)
- EmailTemplate : templates emails (optionnel)

**Relations clés** :
- Lead 1:1 Folder
- Folder 1:n Quote (10 devis)
- Folder 1:1 Booking
- Quote 1:1 Booking
- Mover 1:n PricingGrid, Quote, Booking, User

**Features** :
- Flux complet : Lead → Folder → Quote → Booking → Payment
- Validation admin obligatoire pour quotes parsed
- Scoring financier manuel (CreditSafe web, pas API)
- Champs Google Places integration
- Stripe tracking (payment intent, transfer)
- Index performance (status, foreign keys, composite)
- Contraintes CASCADE et UNIQUE
- Timestamps automatiques (createdAt, updatedAt)

Total : 626 lignes ajoutées

---

## [5ec366d] P0-t005: Apply 8 critical corrections for production readiness
**Date** : 2025-11-10

**Fichiers** :
- .cursor/tasks/P0-t005-schema-core-back-office.md
- .cursor/tasks/P0-t005-SUMMARY.md (créé)

**Changements critiques** :

✅ **1. FK brisée corrigée**
- Quote.validatedBy → Quote.validatedByUserId + User relation
- EmailLog.folderId/moverId → FK correctes vers Folder/Mover
- Quote.pricingGridId → FK vers PricingGrid

✅ **2. Redondance supprimée**
- Booking.moverId retiré (accès via booking.quote.mover)

✅ **3. Précision financière**
- Float → Decimal(10,2) : totalPrice, depositAmount, commissionAmount, etc.
- Float → Decimal(5,2) : scores (scorePrice, scoreTotal, etc.)
- Float → Decimal(6,2) : volume, estimatedVolume
- Float → Decimal(7,2) : distance
- Float → Decimal(3,2) : googleRating

✅ **4. Choix client tracé**
- Folder.selectedQuoteId ajouté (tracking avant Booking)
- Relation Folder→SelectedQuote (1:1)

✅ **5. Inventaire IA**
- Lead.estimationMethod (enum : AI_PHOTO, FORM, MANUAL_ADMIN)
- Lead.photosUrls (@db.Text JSON)
- Lead.aiEstimationConfidence (Decimal 5,2)

✅ **6. Protection données**
- onDelete Cascade → Restrict (PricingGrid, Quote, Booking, Payment)
- Soft delete ajouté partout (deletedAt DateTime?)
- Index deletedAt sur tous modèles

✅ **7. Index composites manquants**
- [folderId, scoreTotal] : requêtes Top 3 optimisées
- originPostalCode, destPostalCode : filtres zones
- validUntil : requêtes "quotes expirés"
- paidAt : rapports financiers
- confirmedAt : rapports bookings
- city : recherche movers

✅ **8. Table Top3Selection**
- Snapshot figé des 3 quotes présentés
- Scores et prix au moment présentation (immutables)
- Tracking clientViewedAt, clientSelectedAt

**Améliorations additionnelles** :
- Quote.reminderCount + lastRemindedAt (remplace REMINDED_1/2)
- Folder.volumeAdjustedBy/At/Reason (traçabilité)
- Payment.idempotencyKey (anti-doublon webhooks)
- Commentaires rôle + données sensibles sur tous modèles
- @db.Text pour large strings
- @db.VarChar(14) pour SIRET
- @db.VarChar(3) pour currency

**Compatibilité Neon** :
- ✅ Tous types supportés (Decimal, UUID, Enum, Text)
- ✅ Index composites conformes syntaxe PostgreSQL
- ✅ onDelete actions natives
- ✅ Pas de CHECK constraints (validation app-layer)

**Résumé créé** : P0-t005-SUMMARY.md
- Changements détaillés
- Compatibilité PostgreSQL 15+
- Prochaines étapes (migration, seeding, Zod)
- Checklist pré-prod

Total : 228 insertions, 101 suppressions

